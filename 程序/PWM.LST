C51 COMPILER V9.54   PWM                                                                   11/29/2021 17:11:49 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE PWM
OBJECT MODULE PLACED IN PWM.OBJ
COMPILER INVOKED BY: E:\Keil\C51\BIN\C51.EXE PWM.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include<reg52.h>    
   2          #include<intrins.h>                        
   3          #define uchar unsigned char 
   4          #define uint unsigned int 
   5              
   6          /**********************************************************************
   7                        L298n接口定义
   8          **********************************************************************/  
   9          sbit MOTOR_A_1=P3^6;
  10          sbit MOTOR_A_2=P3^7;                                   
  11          sbit k1=P1^0;   //定义k1为p1.0口
  12          sbit k2=P1^1;   //定义k2为p1.1口
  13          sbit k3=P1^2;   //定义k3为p1.2口
  14          sbit k4=P1^3;   //定义k4为p1.3口
  15          int T=0;     //定时标记
  16          int W=0;     //脉宽值  0~100
  17          uchar A=0;     //方向标记 0，1
  18          uchar k=0;     //按键标记
  19          uchar i=0;       //计数变量
  20          
  21          uchar code table1[]={
  22          0x3f,0x06,0x5b,0x4f,
  23          0x66,0x6d,0x7d,0x07,
  24          0x7f,0x6f,0x77,0x7c,
  25          0x39,0x5e,0x79,0x71};
  26          
  27          uchar code table2[]={0xfe,0xfb,0xfd,0xf7};
  28               
  29          void delayms(uint t);                
  30          /**********************************************************************
  31                      数码管显示
  32          **********************************************************************/ 
  33          void disp(void)
  34          {
  35   1        P2=table2[3];         
  36   1        P0=table1[W%10];      //显示占空比个位
  37   1        delayms(3);           //延时1ms
  38   1        P2=0xff;              //P0清1
  39   1      
  40   1        P2=table2[2];
  41   1        P0=table1[W/100];     //显示占空比百位
  42   1        delayms(3);           //延时1ms
  43   1        P2=0xff;              //P0清1
  44   1        
  45   1        P2=table2[1];
  46   1        P0=table1[W/10%10];  //显示占空比十位
  47   1        delayms(3);          //延时1ms
  48   1        P2=0xff;             //P0清1
  49   1      
  50   1        P2=table2[0];
  51   1        P0=table1[A];       //显示方向
  52   1        delayms(3);         //延时1ms
  53   1        P2=0xff;            //P0清1
  54   1      }
  55          
C51 COMPILER V9.54   PWM                                                                   11/29/2021 17:11:49 PAGE 2   

  56          /**********************************************************************
  57                        定时器变量定义
  58          **********************************************************************/ 
  59          
  60          
  61          void init(void)
  62          {
  63   1        //启动中断
  64   1        TMOD=0x01;  
  65   1        EA=1;           
  66   1        ET0=1;
  67   1        TR0=1;
  68   1        //设置定时时间
  69   1        TH0=(65536-100)/256;
  70   1        TL0=(65536-100)%256;
  71   1      }
  72          
  73          void timer0() interrupt 1
  74          {            
  75   1        //重置定时器时间
  76   1        TH0=(65536-100)/256;
  77   1        TL0=(65536-100)%256;
  78   1        T++;      //定时标记加1 
  79   1        if(k==0)
  80   1        {
  81   2        if(T>W)
  82   2          MOTOR_A_1 =0;
  83   2        else
  84   2          MOTOR_A_1 =1;
  85   2        }
  86   1        else
  87   1        {
  88   2        if(T>W)
  89   2          MOTOR_A_2 =0;
  90   2        else
  91   2          MOTOR_A_2 =1;
  92   2        }
  93   1          
  94   1        if(T==100)
  95   1          T=0; 
  96   1      }     
  97          /**********************************************************************
  98                        延时1ms
  99          **********************************************************************/ 
 100          void delayms(uint t)
 101          {
 102   1        uchar j;
 103   1        while(t--)
 104   1        {
 105   2          for(j=0;j<40;j++)     //循环250次
 106   2          {
 107   3             _nop_();             //系统延时          
 108   3               _nop_();             //系统延时
 109   3               _nop_();             //系统延时
 110   3               _nop_();             //系统延时
 111   3          }
 112   2        }
 113   1      }
 114          /**********************************************************************
 115                        独立按键检测
 116          **********************************************************************/ 
 117          void key(void)           //按键判断程序
C51 COMPILER V9.54   PWM                                                                   11/29/2021 17:11:49 PAGE 3   

 118          {
 119   1        if(k1==0)             //按键1按下
 120   1        {
 121   2          while(k1==0);       //按键1抬起
 122   2          if(W==100)          //如果脉宽为100
 123   2            W=0;              //脉宽置0
 124   2          else
 125   2            W+=1;             //否则加1
 126   2        }
 127   1        else if(k2==0)        //按键2按下
 128   1        {        
 129   2          while(k2==0);       //按键2抬起
 130   2          if(W==0)            //如果脉宽为0
 131   2            W=100;            //脉宽设置成100
 132   2          else
 133   2            W-=1;             //否则减1
 134   2        }
 135   1        else if(k3==0)        //按键3按下
 136   1        {        
 137   2          while(k3==0);       //按键3抬起
 138   2          A=!A;               //方向标记取反
 139   2          k=!k;               //按键标记取反
 140   2        } 
 141   1        else if(k4==0)        //按键4按下
 142   1        {        
 143   2          while(k4==0);       //按键4抬起
 144   2          W=0;                //脉宽清0                 
 145   2        }
 146   1      }
 147          
 148          void main(void)
 149          {
 150   1      
 151   1        init();     /////////系统初始化 
 152   1        while(1)   
 153   1        {
 154   2        disp();   //数码管显示
 155   2        if(k==0)
 156   2            MOTOR_A_2=0;
 157   2        else
 158   2          MOTOR_A_1=0;      
 159   2          key();      ////////查询按键
 160   2        }
 161   1      }
 162          
 163          /**********************************************************************
 164                          END
 165          **********************************************************************/ 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    369    ----
   CONSTANT SIZE    =     20    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
